@namespace Masa.Tsc.Web.Admin.Rcl.Components

<MRow>
    <MCol Md="12">
        <DynamicComponent Type="@CurrentComponentModule.ShowType" Parameters=CurrentComponentModule.Metadata />
    </MCol>
    <MCol Md="12">
        <MCard>
            <MCardTitle>
                <MRow>
                    <MCol Md="6">
                        <SSelect @bind-Value="@Value.SystemIdentity" Items="_systemIdentities"
                                 ItemText="item => item"
                                 ItemValue="item => item" />
                    </MCol>
                    <MCol Md="6" Align="AlignTypes.End">
                        <MButtonGroup Value="@Value.ListType.ToString()" ValueChanged="ListTypeChanged" Mandatory>
                            <MButton Class="text-capitalize" Value="@ListTypes.ServiceList.ToString()">
                                Service List
                            </MButton>
                            <MButton Class="text-capitalize" Value="@ListTypes.EndpointList.ToString()">
                                Endpoint List
                            </MButton>
                            <MButton Class="text-capitalize" Value="@ListTypes.InstanceList.ToString()">
                                Instance List
                            </MButton>
                            <MButton Class="text-capitalize" Value="ListTypes.TopList.ToString()">
                                Top List
                            </MButton>
                        </MButtonGroup>
                    </MCol>
                </MRow>
            </MCardTitle>
            <MCardText>
                <DynamicComponent Type="@CurrentComponentConfiguration.ShowType" Parameters=CurrentComponentConfiguration.Metadata />
            </MCardText>
        </MCard>
    </MCol>
</MRow>

@code {
    [Parameter]
    public ITablePanelValue Value { get; set; }

    [Parameter]
    public EventCallback<string> OnListTypeChanged { get; set; }

    private List<string> _systemIdentities = new List<string>();
    private StringNumber _listType = "service-list";
    Dictionary<ListTypes, DynamicComponentDescription> ComponentModuleMap { get; set; }
    Dictionary<ListTypes, DynamicComponentDescription> ComponentConfigurationMap { get; set; }

    DynamicComponentDescription CurrentComponentModule => ComponentModuleMap[Value.ListType];

    DynamicComponentDescription CurrentComponentConfiguration => ComponentConfigurationMap[Value.ListType];

    protected override void OnInitialized()
    {
        ComponentModuleMap = new()
        {
            [ListTypes.ServiceList] = new(typeof(ServiceListDemo), new() { ["Value"] = Value }),
            [ListTypes.InstanceList] = new(typeof(InstanceListDemo), new() { ["Value"] = Value }),
            [ListTypes.EndpointList] = new(typeof(EndpointListDemo), new() { ["Value"] = Value }),
            [ListTypes.TopList] = new(typeof(TopListDemo), new() { ["Value"] = Value })
        };

        ComponentConfigurationMap = new()
        {
            [ListTypes.ServiceList] = new(typeof(ServiceListConfiguration), new() { ["Values"]=Value.Metrics }),
            [ListTypes.InstanceList] = new(typeof(InstanceListConfiguration), new() { ["Values"] = Value.Metrics }),
            [ListTypes.EndpointList] = new(typeof(EndpointListConfiguration), new() { ["Values"] = Value.Metrics }),
            [ListTypes.TopList] = new(typeof(TopListConfiguration), new() { ["Values"] = Value.Metrics })
        };
        base.OnInitialized();
    }

    private void ListTypeChanged(StringNumber listType)
    {
        Value.ListType = Enum.Parse<ListTypes>(listType.ToString()!);
        Value.Metrics.Clear();
        if (OnListTypeChanged.HasDelegate)
        {
            OnListTypeChanged.InvokeAsync(listType.AsT0);
        }
    }
}
